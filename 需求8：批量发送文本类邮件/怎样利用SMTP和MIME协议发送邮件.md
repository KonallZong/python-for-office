# 使用SMTP和MIME协议批量发送含正文、图片、音视频、附件等的邮件（Python语言实现）

> 本文所述的SMTP协议，确切地说，应该是SMTPs协议（SMTP-over-SSL），即基于SSL加密后的一种SMTP协议变种。
>
> 超详细！教科书级别的实践参考！
>
> 如有斟误或补充，请联系作者。





## 1. SMTP和MIME协议简介

**Note：如果您以前没有接触过此类应用，可以在研读完“Python语言实现邮件批量发送”部分的代码后回到此部分进行梳理，如果学有余力，可以继续阅读《计算机网络》相关教科书及其它文献、博客等，深入学习该应用中的牵涉的各种理论知识。**



### 	1.1 SMTP协议

***

#### 		1.1.1 概述

* 中文全名：简单邮件传输协议
* 英文拼写：**S**imple **M**ail **T**ransfer **P**rotocal



**基于文本**的一个协议，指定消息的一个或多个接收者（即：收件人和抄送人），然后消息文本就会传输。

> 最早的SMTP协议只支持传输可打印的7位ASCII字符邮件，二进制文件（例如图片、音视频文件等）都不能传，此外还有各种各样的瓶颈和不足。于是有了MIME协议对SMTP协议做扩展。



``附：SMTPs协议简述``

SMTP协议**基于SSL安全协议**之上的一个变种，安全性更高，防止邮件在传输过程中被截取泄密，还能防止**发送者抵赖（发送者发送邮件以后删除内容，然后拒不承认自己发过这份邮件）**。

本文后面进行实现时，采用的SMTP协议，就是指这个更安全的SMTPs协议。

***

#### 		1.1.2 SMTP协议邮件内容组成部分

SMTP规定：邮件由**邮件头部（header）**和**邮件主体（body）**组成。

> 如果把邮件比作一封信，那么邮件头部就相当于信封，上面有主题、还指定了这封信从何而来（发送方信息）、到哪里去（接收方信息）等这样一些内容。我们可以这样子去进行类比。



1. **邮件头部（header）**

|   字段   |           含义            | 备注 |
| :------: | :--------------------------------------: | :--------------------------------- |
|   **From**   |     邮件发送方的信息      | 常用、**可由系统自动填入**自己信息或自定义。<br />格式：``发送方名称(可自定义) <发送方的邮箱>``（中间有一个空格）<br />格式样例：``define_your_name <your_email_name@the_host_name.com>`` |
|    **To**    |     邮件接收方的信息      | 常用、且**最重要**。<br />格式：``接收方名称(可自定义) <接收方的邮箱>``（中间有一个空格）<br />格式样例：同前**From**字段所述。 |
| **Subject** |        邮件的主题         |                常用、且**最重要**。<br />内容可自定义。                |
|   Date   |         发信日期          |                  常用、**通常由系统自动填入。**                  |
| Reply-To | 接收方回信时所采用的地址  | 较少用。<br />回信采用地址可以与发送方不同。<br />使用场景：借自己同学邮箱发送邮件后，想让回复的邮件到自己的邮箱中来，可以预设这个属性。<br />格式样例：同前**From**字段所述。 |
|    Cc    | 抄送（Carbon copy）方信息 |                         较少用。<br />格式：``抄送方名称(可自定义) <抄送方的邮箱>``（中间有一个空格）。<br />格式样例：同前**From**字段所述。                         |
| Bcc | 暗送（Blind carbon copy）方信息 | 较少用。<br />格式：``抄送方名称(可自定义) <抄送方的邮箱>``（中间有一个空格）。<br />格式样例：同前**From**字段所述。 |

Note：

* 大家**可以先只着重了解From，To和Subject**三个字段，后面实现邮件批量发送的演示代码，也只用到了这三个。

* 有关**直接发送、抄送和暗送的区别**这里不进行赘述，也不是这篇文档关注的主要矛盾，我们考虑另起文档进行实验报告。



2. **邮件主体（body）**

主体内容即邮件里面写了什么东西，这个部分可以让**用户“自由”编辑**。

为什么“自由”两个字打了引号呢？因为SMTP协议只支持传输7位ASCII码字符，假如说只有SMTP协议，那么最后的结果就是：

* 中文不支持、非英语国家的字符不支持
* 不能传送二进制流数据的文件（例如图片、音视频、附件等）
* 除此之外还有其它很多很多的问题，这里不赘述了

所以说这种“自由”，仅限于7位ASCII码支持的字符数据可自由编辑，其它的数据没法传呀......

**于是后来有了MIME协议，解决了上述的局限，所谓的“用户‘自由’编辑”，终于可以把“自由”的引号摘掉了。我们接着往下看。**

***



### 	1.2 MIME协议

***

#### 		1.2.1 概述

* 中文全名：多用途互联网邮件扩展协议
* 英文拼写：**M**ultipurpose **I**nternet **M**ail **E**xtensions



**MIME协议是对SMTP协议的扩展协议。**



MIME协议中，邮件是一个或者多个“板块”（或者说**“报文”**）进行封装组装，每一个报文都支持它的数据被解析为某一种特定的内容类型**Content-Type**（如普通文本、html文本、图像、音视频、**multipart容器**等等），其中**multipart容器**非常有用，允许单个报文里面嵌套多个彼此独立的子报文。每个子报文还可以继续添加数据，并设置自己独立的类型、编码等。

上面这段话说了很多内容，简言之，**直接现象就是，MIME协议规定的邮件，可以支持各种不同的语言，可以同时放图片、音视频文件、附件等等**。

> 始终牢记一点：MIME协议是SMTP协议的扩展，MIME协议是SMTP协议的扩展，MIME协议是SMTP协议的扩展。脑海中默念3次。

***

#### 		1.2.2 MIME协议邮件内容组成部分

> 由于MIME协议是SMTP的扩充，所以MIME协议同样支持SMTP协议的7为ASCII编码字符，同样包含了SMTP协议指定的邮件头部字段。
>
> 不过既然是扩展，MIME协议相较SMTP协议，还增加了一些辅助字段。

与SMTP协议一样，MIME协议大体还是分为了**邮件头部（header）**和**邮件主体（body）**两个部分，不过在SMTP协议的<u>原有基础</u>上，做了扩充。



1. **邮件头部（header）**

> 由于MIME协议支持子报文。

|           字段            |                 含义                 | 备注                                                         |
| :-----------------------: | :----------------------------------: | :----------------------------------------------------------- |
|    SMTP协议原设有字段     |               见1.1.2                | 见文档1.1.2部分“SMTP协议邮件内容组成”邮件头部（header）<br />原有的字段在MIME协议邮件头部依然适用<br />且**From，To，Subject**属性仍非常重要 |
|       MIME-Version        |             MIME协议版本             | 常见版本1.0，**无需设置**，按默认来即可。                    |
|        Content-Id         |            MIME邮件标识符            | 如果采用**multipart类型容器**：<br />仅从邮件中**标识一个子报文**。<br /><br />如果邮件是non-multipart（非容器）：<br />标识一个完整的邮件。<br /><br />常用情景：<br />将本地资源嵌入邮件，需要使用multipart容器，<br />并构造子报文和对应子报文的Content-Id，<br />这个Content-Id将用于给html文本子报文调用显示。<br /><br />**较常用**字段之一。 |
|       Content-Type        | 邮件传输数据<br />是什么样的文件类型 | 指定传输来的**数据解析成什么类型的文件**。（eg：文本文件？还是ppt文件之类的？）<br />可选参数：charset，说明邮件主体内容**以什么编码呈现**（防止乱码）<br />（通常建议取**utf-8**）<br />**最常用**字段之一。<br />Content-Type有很多类型，这种情况下要查表。<br />Content-Type查询表：[MIME 参考手册 (w3school.com.cn)](https://www.w3school.com.cn/media/media_mimeref.asp)<br />如果邮件采用**multipart类型容器**：<br />仅说明邮件中**一个子报文**传输数据的类型。<br />如果邮件是non-multipart（非容器）：<br />说明的就是一个完整邮件所传输数据的类型。<br /><br />格式：``Content-Type: 父类型/子类型[; charset=内容呈现的编码字符集（非必选）]``<br />格式举例：``Content-Type: text/html; charset=utf-8``（注意冒号、分号后都有一空格） |
| Content-Transfer-Encoding |             内容传送编码             | 描述在**传送过程中**邮件的主体是如何进行编码的。<br />（默认值为**base64**，通常取默认值就好了，传送过程的编码我们无需操心，放心交给协议去做就好） |
|    Content-Description    |               内容描述               | 可读字符串，辅助描述邮件内容。<br />可自定义、**非必选**。   |

另一个对MIME协议扩展的字段：

下面的这个字段并不是MIME协议指定的字段，而是HTTP协议响应头（response header）的一个字段，但可以用于MIME协议邮件头部进行扩展。

|        字段         |      含义      | 备注                                                         |
| :-----------------: | :------------: | ------------------------------------------------------------ |
| Content-Disposition | 附件和别名配置 | 主要在需要**指定邮件附件**的场景下进行设置。<br />可以用在multipart子报文中。<br /><br />指示浏览器以何种形式展示附件。<br /><br />可选参数：``filename``，如果设置了，<br />表示浏览器下载附件时的默认文件名，<br />如果不设置可能就是一堆乱码。 |

备注中所述的“附件的展示形式”有两种形式：

* attachment：附件。设置这个值以后，消息体应该被下载到本地；大多数浏览器会呈现一个“保存为”的对话框。
  假如将 `filename` 的值预填为下载后的文件名。
* inline：内联。浏览器响应体（response body）会以页面的一部分或者整个页面的形式展示

**下面是这个字段的使用格式**

* 使用格式：

``Content-Disposition: <展示形式>[; filename="自定义文件名"]``

* 格式样例：

```python
Content-Disposition: inline
Content-Disposition: attachment
Content-Disposition: attachment; filename="filename.jpg"
```

> 需要注意的是：Content-Disposition这个扩展字段，在邮件发送的情境下，主要作用是设置附件在接收方浏览器中显示的文件名。不指定这个参数也可以，但是接收方显示的附件文件名可能会是乱码，不过不影响附件内容。



Note：

* 同是编码，Content-Type字段中的charset和Content-Transfer-Encoding是有区别的
  * Content-Type中的charset：描述的是数据中**实际内容**应当采取什么编码呈现，确保**用户不会看到乱码**（通常为**utf-8**）
  * Content-Transfer-Encoding：描述的是数据在**网络传输当中**按照什么方式压缩和传输邮件主体的（通常取为**base64**）

* 关于字段设置的注意事项
  * 用到multipart容器组合报文：仅容器需要设置SMTP原有字段（收发方信息、主题等），内部子报文无需设置；其它字段按需照常设置
  * 未用multipart容器组合报文：该报文就是邮件的内容，需要设置SMTP原有字段
* 有关字段具体设置的实例，后面会有例子具体说明的。



2. **邮件主体（body）**

主体内容即邮件里面写了什么东西，这个部分可以让**用户自由编辑**。

不同于SMTP协议中的“自由”需要打上引号，这里的自由是指：

* 支持不同语种字符
* 支持嵌入图片、音视频等资源
* 支持各种类型附件

只需要注意，用户在构造上述数据时，需要遵守MIME协议，**文本文件传入文本数据到MIME报文主体部分、二进制文件传入数据二进制流到MIME报文主体部分**，即可完成必要的设计。

***



### 1.3 SMTP协议和MIME协议的关系

下面这张图，非常清晰地表达了MIME协议和SMTP协议的关系。（图片摘自：谢希仁《计算机网络（第7版）》第292页图6-18）

<img src="C:\Users\61959\AppData\Roaming\Typora\typora-user-images\image-20210522155426742.png" alt="图：MIME和SMTP的关系描述图（摘自谢希仁《计算机网络（第7版）》）" style="zoom: 50%;" />

MIME协议没有取代或者更改SMTP协议，只是在SMTP协议的基础上进行了扩充，所以SMTP可识别的字段在MIME协议下也是可识别的。

* 发送时，不管用户编辑的邮件内容是否为7位ASCII字符、是否为二进制文件数据流，MIME协议都会将这些内容转换为SMTP协议支持的7位ASCII码（大多数可能是乱码）再进行传输；
* 接收时，MIME协议会通过内部机制，将SMTP协议传输而来的7位ASCII码（大多数可能是乱码）转换为二进制文件数据流或者其它编码集的字符，使文本、图片、音视频、附件等都能按发送方期盼原样呈现。

***





## 2. 发送邮件的整体思路、过程和Demo

结合1.3部分中描述的“SMTP协议和MIME协议的关系图”，我们可以知道，**站在用户的视角，我们邮件内容的准备工作应当以MIME协议为规则**，不过在设置MIME协议的一些字段的时候，其实有的字段（From，To，Subject）这样的也算是SMTP协议的字段，只不过MIME协议基于此有其它扩展而已。



### 2.1 发送的总体流程

***

> 这个板块的内容，建议你看完后面的例子以后再回来回顾一下呢，这个就是我们接下来

1. 登录邮件服务器，需要指定以下内容

* 邮件服务器的域名（例如：QQ邮件系统服务器smtp.qq.com，网易邮件系统服务器：smtp.163.com等）
* 登录用户名：发送方的邮箱
* 登录授权码：这里的授权码可能并不是登录邮箱的密码，而是通过邮箱服务器规定的方式获取的授权码，需要结合相应邮件系统的文档操作（例如接下来的例子中，qq邮箱就需要结合引导来获取授权码）



2. 准备邮件的内容：结合MIME协议准备数据、拼装MIME报文

用户可以选择直接使用nonmultipart类型的MIME报文，指定邮件头部和数据以后直接发送，但**为了让解决方案具有通用性，以下只描述使用multipart类型的MIME报文时，需要考虑的准备数据情景**

* 混合报文类型（multipart/mixed）的容器：这个容器将包含邮件的所有下述其它子报文，发送邮件时
* 文本数据（text），其中还可以分为两种子类别
  * 普通文本（Content-Type: text/plain）：编辑什么内容就显示什么内容
  * html文本（Content-Type: text/html）：编辑的文本按照html解析，可以引入想要嵌入的资源进行显示
* 内嵌资源文件：想在邮件正文里显示的图片、音视频等
* 附件：想在邮件里通过下载呈现的任何类型文件

***



### 2.2 文本文件的准备

> 为了让解决方案具有通用性，以下只描述使用multipart类型的MIME报文。
>
> 所有步骤的起点，是2.2.0部分的准备工作完成，从2.2.1部分开始的内容，根据想要发送子报文的需求按需查询。

#### 2.2.0 构造multipart容器报文

大致分如下步骤准备。

1. 指定Content-Type



***

#### 2.2.1 普通文本数据报文

大致分如下步骤准备。

1. 准备好自定义的文本数据。
2. 创建MIME子报文，进行如下配置：

* 子报文头
  * Content-Type：**主类为text，子类为plain**，通常设置编码字符集为utf-8

```python
Content-Type: text/plain; charset: utf-8
```

* 子报文体：加入之前准备好的文本数据。

3. 将子报文添加到multipart容器报文中

> 以下是Python实现

```python
import email.mime.MIMEText
```





***

#### 2.2.2 html文本数据报文

大致分如下步骤准备。



***



### 2.3 内嵌资源数据报文的准备

***

> 这个过程需要联合html文本进行显示



***



### 2.4 附件资源的准备

***



***





## 3. 





***

## 附：参考文献及链接

* 谢希仁编著《计算机网络（第7版）》—第6章 应用层—6.5 电子邮件

* [邮件传输协议SMTP和SMTPS - 楼兰胡杨 - 博客园 (cnblogs.com)](https://www.cnblogs.com/east7/p/13406089.html)
* [MIME 参考手册 (w3school.com.cn)](https://www.w3school.com.cn/media/media_mimeref.asp)

* [header中Content-Disposition的作用与使用方法 - wq9 - 博客园 (cnblogs.com)](https://www.cnblogs.com/wq-9/articles/12165056.html)

* [Content-Disposition - HTTP | MDN (mozilla.org)](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Disposition)

* [王道考研 计算机网络 P72 6.4 电子邮件_哔哩哔哩 (゜-゜)つロ 干杯~-bilibili](https://www.bilibili.com/video/BV19E411D78Q?p=72)

